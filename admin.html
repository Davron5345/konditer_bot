<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .stat-number { font-size: 2em; font-weight: bold; color: #007bff; }
        .filters { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .orders-grid { display: grid; gap: 20px; }
        .order-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .order-id { font-weight: bold; color: #007bff; }
        .order-status { padding: 5px 10px; border-radius: 15px; font-size: 0.8em; }
        .status-new { background: #ffeb3b; }
        .status-confirmed { background: #2196f3; color: white; }
        .status-printed { background: #4caf50; color: white; }
        .status-cancelled { background: #f44336; color: white; }
        .order-items { margin: 10px 0; }
        .order-total { font-weight: bold; text-align: right; }
        .btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; margin: 2px; }
        .btn-print { background: #4caf50; color: white; }
        .btn-confirm { background: #2196f3; color: white; }
        .btn-cancel { background: #f44336; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞–º–∏</h1>
            <p>–ö–æ–Ω–¥–∏—Ç–µ—Ä—Å–∫–∞—è –±–æ—Ç</p>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="today-orders">0</div>
                <div>–ó–∞–∫–∞–∑–æ–≤ —Å–µ–≥–æ–¥–Ω—è</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="today-revenue">0‚ÇΩ</div>
                <div>–í—ã—Ä—É—á–∫–∞ —Å–µ–≥–æ–¥–Ω—è</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="weekly-orders">0</div>
                <div>–ó–∞–∫–∞–∑–æ–≤ –∑–∞ –Ω–µ–¥–µ–ª—é</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="weekly-revenue">0‚ÇΩ</div>
                <div>–í—ã—Ä—É—á–∫–∞ –∑–∞ –Ω–µ–¥–µ–ª—é</div>
            </div>
        </div>

        <div class="filters">
            <button onclick="loadOrders()">–í—Å–µ</button>
            <button onclick="loadOrders('new')">–ù–æ–≤—ã–µ</button>
            <button onclick="loadOrders('confirmed')">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ</button>
            <button onclick="loadOrders('printed')">–†–∞—Å–ø–µ—á–∞—Ç–∞–Ω–Ω—ã–µ</button>
            <button onclick="loadOrders('cancelled')">–û—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ</button>
        </div>

        <div class="orders-grid" id="orders-container">
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</p>
        </div>
    </div>

    <script>
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                
                document.getElementById('today-orders').textContent = stats.today.orders || 0;
                document.getElementById('today-revenue').textContent = (stats.today.revenue || 0) + '‚ÇΩ';
                document.getElementById('weekly-orders').textContent = stats.weekly.orders || 0;
                document.getElementById('weekly-revenue').textContent = (stats.weekly.revenue || 0) + '‚ÇΩ';
            } catch(e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', e);
            }
        }

        async function loadOrders(status = null) {
            try {
                const url = status ? `/api/orders?status=${status}` : '/api/orders';
                const response = await fetch(url);
                const orders = await response.json();
                
                const container = document.getElementById('orders-container');
                container.innerHTML = '';
                
                if (orders.length === 0) {
                    container.innerHTML = '<p style="text-align:center;padding:20px;">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</p>';
                    return;
                }
                
                orders.forEach(order => {
                    const orderEl = document.createElement('div');
                    orderEl.className = 'order-card';
                    
                    let itemsHtml = '';
                    if (order.items) {
                        order.items.forEach(item => {
                            itemsHtml += `<div>${item.name} - ${item.quantity} √ó ${item.price}‚ÇΩ = ${item.total}‚ÇΩ</div>`;
                        });
                    }
                    
                    orderEl.innerHTML = `
                        <div class="order-header">
                            <span class="order-id">–ó–∞–∫–∞–∑ #${order.id}</span>
                            <span class="order-status status-${order.status}">${getStatusText(order.status)}</span>
                        </div>
                        <div><strong>–ö–ª–∏–µ–Ω—Ç:</strong> ${order.customer || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                        <div><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${order.phone || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                        <div><strong>–ê–¥—Ä–µ—Å:</strong> ${order.address || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                        <div class="order-items"><strong>–¢–æ–≤–∞—Ä—ã:</strong>${itemsHtml}</div>
                        <div class="order-total">–ò—Ç–æ–≥–æ: ${order.total_amount}‚ÇΩ</div>
                        <div><small>–°–æ–∑–¥–∞–Ω: ${order.created_at}</small></div>
                        <div style="margin-top:10px;">
                            ${order.status !== 'printed' ? `<button class="btn btn-print" onclick="printOrder(${order.id})">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>` : ''}
                            ${order.status === 'new' ? `<button class="btn btn-confirm" onclick="updateStatus(${order.id}, 'confirmed')">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>` : ''}
                            ${order.status !== 'cancelled' ? `<button class="btn btn-cancel" onclick="updateStatus(${order.id}, 'cancelled')">‚ùå –û—Ç–º–µ–Ω–∏—Ç—å</button>` : ''}
                        </div>
                    `;
                    
                    container.appendChild(orderEl);
                });
            } catch(e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤:', e);
                document.getElementById('orders-container').innerHTML = '<p style="color:red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤</p>';
            }
        }

        function getStatusText(status) {
            const statuses = {
                'new': '–ù–æ–≤—ã–π',
                'confirmed': '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω',
                'printed': '–†–∞—Å–ø–µ—á–∞—Ç–∞–Ω',
                'cancelled': '–û—Ç–º–µ–Ω–µ–Ω'
            };
            return statuses[status] || status;
        }

        async function printOrder(orderId) {
            alert(`–ü–µ—á–∞—Ç—å –∑–∞–∫–∞–∑–∞ #${orderId} (—Ñ—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)`);
        }

        async function updateStatus(orderId, status) {
            try {
                const response = await fetch(`/api/order/${orderId}/status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                
                if (response.ok) {
                    loadOrders();
                    loadStats();
                } else {
                    alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
                }
            } catch(e) {
                console.error('–û—à–∏–±–∫–∞:', e);
                alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadStats();
        loadOrders();
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        setInterval(() => {
            loadStats();
            loadOrders();
        }, 30000);
    </script>
</body>
</html>
